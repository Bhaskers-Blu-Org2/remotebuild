<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
    <SchemaVersion>2.0</SchemaVersion>
    <ProjectGuid>{b28c65d0-85a6-48ba-9909-5d4c8498b964}</ProjectGuid>
    <ProjectHome>..\src\</ProjectHome>
    <OutputPath>$(TF_BUILD_BINARIESDIRECTORY)</OutputPath>
    <VisualStudioVersion Condition="'$(VisualStudioVersion)' == ''">11.0</VisualStudioVersion>
    <VSToolsPath Condition="'$(VSToolsPath)' == ''">$(MSBuildExtensionsPath32)\Microsoft\VisualStudio\v$(VisualStudioVersion)</VSToolsPath>
    <GulpRoot>$(MSBuildThisFileDirectory)\..\</GulpRoot>
  </PropertyGroup>

  <PropertyGroup Condition="'$(Configuration)' == 'Debug'" />
  <PropertyGroup Condition="'$(Configuration)' == 'Release'" />
  
  <!--Enables Build Project scenario  in VS-->
  <Target Name="Build" >
    <Message Text="Installing gulp"/>
    <Exec Command="npm install gulp" WorkingDirectory="$(GulpRoot)" />
    <Message Text="Building project" />
    <Exec Command="$(GulpRoot)\node_modules\.bin\gulp.cmd prep" WorkingDirectory="$(GulpRoot)\src" />
    <MakeDir Directories="$(TF_BUILD_DROPLOCATION)\packages\"/>
    <Exec Command="$(GulpRoot)\node_modules\.bin\gulp.cmd build --drop=$(TF_BUILD_DROPLOCATION)\packages\" WorkingDirectory="$(GulpRoot)\src" />
    <ItemGroup>
      <BuildPackages Include="$(MSBuildThisFileDirectory)\..\build\packages\**\*" />
    </ItemGroup>
    <Message Text="Copying sources to bin folder" />
    <Copy SourceFiles="@(BuildPackages)" DestinationFiles="@(BuildPackages->'$(TF_BUILD_BINARIESDIRECTORY)\packages\%(RecursiveDir)%(Filename)%(Extension)')"/>
    <Copy SourceFiles="$(MSBuildThisFileDirectory)updateDynamicDependencies.js" DestinationFolder="$(TF_BUILD_BINARIESDIRECTORY)\packages\node_modules"/>
    
    <!--Clean up devDependencies to make sure microbuild can delete sources and start fresh-->
    <Exec Command="node $(GulpRoot)\node_modules\gulp\bin\gulp.js unprep" WorkingDirectory="$(GulpRoot)\src" />
  </Target>

  <!--Enables Clean Project scenario  in VS-->
  <Target Name="Clean">
    <Exec Command="$(GulpRoot)\node_modules\.bin\gulp.cmd clean" WorkingDirectory="$(GulpRoot)\src" />
  </Target>

  <!--Enables Rebuild Project scenario in VS -->
  <Target Name="Rebuild" DependsOnTargets="Clean;Build" />
</Project>
